var express = require('express');
var mung = require('express-mung');
var rs = require('../misc/rs');
var router = express.Router();
var token = require('../util/token')();

/* GET home page. */
module.exports = function (ctx) {
    function modifyToRS(body, req, res) {
        return rs.web.response(body);
    }
    ctx.app.use(mung.json(modifyToRS));

    var context = {
        service: ctx.service
    };

    //Check JWT token validity and extract encrypted data
    router.all('*', function (req, res, next) {
        var rs_token = req.headers['rs_token'];
        if (rs_token) {
            var decoded_data = token.verify(rs_token);
            context.current_user = decoded_data.data;
        }
        next();
    });


    var user = require('./user')(context);
    var auth = require('./auth')(context);
    var me = require('./me')(context);

    return [
        { route: '/', handler: router },
        { route: '/me', handler: me },
        { route: '/users', handler: user },
        { route: '/auth', handler: auth }
    ]
};